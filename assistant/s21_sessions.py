import os
import time
import asyncio
from dotenv import load_dotenv
from telethon import TelegramClient, events
import google.generativeai as genai
from datetime import datetime, timedelta

# Загрузка переменных окружения
load_dotenv()
api_id = int(os.getenv("API_ID"))
api_hash = os.getenv("API_HASH")
gemini_api_key = os.getenv("GEMINI_API_KEY")
target_chat_id = int(os.getenv("TARGET_CHAT_ID"))  # ID группы

# Настройка Gemini
genai.configure(api_key=gemini_api_key)
model = genai.GenerativeModel(
    "gemini-2.5-flash-preview-05-20",
    system_instruction=("Ты — чат-бот по имени Astro. "
                    "Ты разговариваешь на всех языках мира."
                    "Отвечай только на сообщения, относящиеся к School 21. "
                    "Если не уверен — направляй в School 21 (контакты у тебя есть) и к саппорту @Zoidov_Zafarjon. "
                    "Если сообщение не связано с School 21 и не является приветствием — ответь строго: `__IGNORE__`.")
)

company_info = [
# ABOUT
  {"role": "user", "parts": "School 21 — это бесплатная IT-школа нового поколения для тех, кто хочет сменить профессию, найти себя в ИТ или получить практические навыки. Обучение построено по принципу «равный обучает равного» — без лекций, менторов и оценок. Вы учитесь через реальные проекты, развиваете софт- и хард-скиллы, сотрудничаете с другими студентами и строите свою образовательную траекторию сами. Школа работает 24/7, можно совмещать с работой или учёбой в вузе. Индивидуальный график, активное профессиональное сообщество, реальные предложения по трудоустройству уже во время обучения — и всё это полностью бесплатно."},
# CONTACTS
  {"role": "user", "parts": "На связи в будни с 10:00 до 19:00."},
  {"role": "user", "parts": "Ташкент, ул. Зиёлилар, 13. (https://yandex.uz/maps/10335/tashkent/house/YkAYdQRlQEUPQFprfX9yeXhnZQ==/?ll=69.334606%2C41.338502&z=17) Ориентир Университет Инха, +998 93 039 4447, tashkent@21-school.uz."},
  {"role": "user", "parts": "Самарканд, ул.Ибн Сино, 17a (https://yandex.ru/maps/org/30165667494), +998930394442,  samarkand@21-school.uz."},
  {"role": "user", "parts": "Зарегистрироваться можно на сайте 21-school.uz (https://21-school.uz/?utm_source=school21&utm_medium=student_tas&utm_campaign=smedleya)."},
  {"role": "user", "parts": "Личный кабинет (https://applicant.21-school.uz/)."},
  {"role": "user", "parts": "По административным вопросам - uzbekistan@21-school.uz ,+998 93 039 5553"},
  
  {"role": "user", "parts": "Что вы получаете: Востребованную профессию - IT-компании испытывают большую нехватку разработчиков. Обучение в School 21 дает возможность приобрести навыки, необходимые современному специалисту на рынке IT. Бесплатное обучение - Обучение полностью бесплатно, без обязательств. Участникам предоставляется все необходимое для прохождения курса. По окончании обучения участники получают сертификат School 21. Гарантированную стажировку - В программе обучения стажировка 3 месяца. Участникам оказывается помощь в поиске оплачиваемой стажировки, соответствующей выбранному направлению обучения. Свободный график 24/7 - Кампус School 21 открыт круглосуточно, что позволяет выбирать свой собственный ритм и график обучения. Современную инфраструктуру - Учебные кластеры оборудованы современными компьютерами, оснащенные всем необходимым soft-ом. В кампусе есть зоны отдыха и игровые комнаты. Актуальные языки программирования - Программа обучения позволяет самостоятельно выбирать направление, языки и учебные проекты которые вы будете реализовывать в рамках основного курса."},
  
  {"role": "user", "parts": "Пиры смогут изучить: DevOps, Frontend (HTML, CSS, JS, TS), Компьютерная графика и GameDev (Unity), Мобильная разработка (Kotlin, Swift), Программирование умных устройств, Алгоритмы и структуры данных, Базы данных, Веб-программирование, Кибербезопасность, Разработка операционных систем, Сети и системное администрирование, Архитектура ПО, Backend (C#, Java/Kotlin, Python, Go), Машинное обучение и анализ данных (Python)"},

  {"role": "user", "parts": "Языки программирования: C, C++, С#, Java, GO, Swift, Python, SQL, JavaScript, Kotlin, TS"},

  {"role": "user", "parts": "Принципы обучения: Нет расписания, оценок и менторов - Ты самостоятельно планируешь день, управляешь свободным временем, чтобы вовремя сдать проекты и проверить работы других участников. Мы ставим дедлайны, даём рабочее место с компьютером и удобный кампус, который открыт 24/7. Всё остальное — в твоих руках. Метод Peer-to-Peer - Обычных уроков и лекций не будет. Вместо этого — методика peer-to-peer (P2P), по которой каждый учится у каждого. У всех участников разный бэкграунд и свой темп в обучении. Работай в команде, делись знаниями и получай опыт от таких же, как ты. Все участники равны. Геймификация - Выполняй задания и получай очки опыта, прокачивай навыки и двигайся вперёд — уровень за уровнем. Участвуй в жизни Школы и получай награды, за проверки других участников — очки. Свои результаты можно сравнить с итогами других участников, чтобы понять точки роста и мобилизоваться."},
  {"role": "user", "parts": "Как проходит обучение: Вступительные этапы - Тест - нужно пройти онлайн игру. У тебя будет одна попытка, 10 уровней, на каждый — 6 шансов. И до 3 часов, чтобы пройти всё. Помни: пройти за 3 часа — можно. А можно — и быстрее. Игра проверит твои базовые навыки необходимые в IT: алгоритмическое мышление, логика, внимание, память и умение справляться с неожиданностями. Вступительные этапы - Встреча с командой School 21 - Расскажем все об обучении. Ответим на любые вопросы. Развеем все сомнения. Встреча проходит в формате вебинара ~ 1 час. Вступительные этапы - Интенсив - Непрерывная учёба в кампусе. Советуем отложить все дела или взять отпуск. 22 проекта, чтобы освоиться в School 21 ~ 26 дней. Основное обучение - Учёба начнётся через несколько недель после интенсива. Специализация, языки программирования и график — на выбор участника. Занятия можно совмещать с работой или учёбой в вузе ~ 1,5–3 года.Диплом государственного образца - Участники получают Диплом государственного образца базового или продвинутого уровня, который подтверждает практические навыки в программировании. Alumni-комьюнити - Выпускники School 21 поддерживают связь друг с другом даже после окончания учёбы: обмениваются опытом, делятся новостями IT, помогают с работой и на проектах. Стань частью сообщества."},
  {"role": "user", "parts": "Диплом государственного образца - Участники School 21 получают диплом государственного образца базового или продвинутого уровня, который подтверждает практические навыки в программировании или других сферах цифровых технологий. Этот документ открывает двери к работе в крупнейших IT-компаниях и высокотехнологичных отраслях, обеспечивая вам конкурентное преимущество на рынке труда. Программа School 21 подходит для участников с любым уровнем подготовки. Новички без опыта смогут освоить новую профессию с нуля, а практикующие специалисты — повысить квалификацию или сменить направление в сфере цифровых технологий."},
  {"role": "user", "parts": "Трудоустройство - Во время учёбы в School 21 каждый участник проходит обязательную стажировку — работает по своему направлению в течение 3-х месяцев. Для School 21 практика в IT-компании — такой же учебный проект, как и все остальные. Участник сам выбирает компанию для стажировки и договаривается о её условиях. Если нужна помощь, School 21 поможет: проведёт карьерную консультацию и оценит резюме; подготовит к собеседованию; организует мероприятия с работодателями и предложит вакансии от компаний-партнёров. На стажировку выходят 100% участников School 21, и 95% из них уже получили предложения о постоянной работе."},
  {"role": "user", "parts": "Партнёры по трудоустройству - truss, SAM IT GLOBAL, G CORE, Beelab, Infin BANK, TRASTBANK, octobank, octo, Beeline, UZUM, Payme, TBC, Biznesni Rivojlantirish Banki, BRB TECH, C7 SEC, babai.io, commeta, SaluteDev, algofrog."},
  {"role": "user", "parts": "Партнёры - O`ZBEKISTON VOLONTYORLARI ASSOTSIYATSIYASI, PDP UNIVERSITY, rtm, SamATI, TECHNO HUB, University of Business and Science,  Yoshlar innovatsiya maktabi, O`ZBEKISTON RESPUBLIKASI RAQAMLI TEXNOLOGIYALAR VAZIRLIGI, DIGITAL EDUCATION DEVELOPMENT CENTER, AloqaVentures, U-Enter, STARTUP GARAGE, IT COMMUNITY OF UZBEKISTAN, astrum, CAU, IDU, IQtidorly, IT BILIM, Kokand University, MU UNIVERSITY, New Uzbekistan University."},
  {"role": "user", "parts": "Кампусы: Самарканд - Самаркандский кампус площадью 4 000 м² объединяет 4 учебных кластера: «Регистан», «Улугбек», «Шердор» и «Тилля-кари». Кампус открыт для участников круглосуточно и здесь они находят всё необходимое для роста в сфере цифровых технологий, создания сообщества единомышленников и комфортного обучения. Инфраструктура Самаркандского кампуса включает: 4 учебных кластеров; 500 рабочих мест; Конференц-зал на 150 мест для мероприятий, мастер-классов и семинаров; Переговорные комнаты; Спортивный зал и игровые зоны для активного отдыха; Обеденные зоны, коворкинги и рекреационные пространства; Общежитие на 180 человек. Ташкент - Кампус School 21 в Ташкенте занимает 8 100 м² и включает 10 учебных кластеров: «Ташкент», «Самарканд», «Бухара», «Хива», «Коканд», «Шахрисабз», «Термез», «Нукус», «Джизак» и «Андижан». Кампус открыт 24/7, включая праздники и выходные. Это позволяет участникам учиться в удобное время, самостоятельно выстраивая свой образовательный путь. Инфраструктура кампуса: 10 учебных кластеров; 700 рабочих мест; Конференц-зал на 300 мест для мероприятий, мастер-классов и семинаров; Лекторий; Переговорные комнаты для командной работы; Игровые зоны и помещения для активного отдыха; Обеденные зоны, коворкинги и рекреационные пространства"},
  {"role": "user", "parts": "Ближайшие отборочные интенсивы: Самарканд: 7 июля, Ташкент: 7 июля."},
  {"role": "user", "parts": "Как выглядит процесс обучения в School 21: Итак, вы успешно прошли интенсив и зачислены на основное обучение. Что вас ждет? В первые 12-15 месяцев вам будут доступны проекты следующих направлений: структурное программирование (С), объектно-ориентированное программирование (С++), компьютерные сети, алгоритмы, базы данных(SQL) и прикладное программирование (java, Python, Golang, C#) После чего наступает время стажировки, она так же является учебным проектом и будет длиться 3 месяца. Где проходить стажировку вы решаете сами. После стажировки в вашем персональном учебном плане откроются ветки для изучения дополнительных направлений и языков: Mobile (Android/iOS, Kotlin/Swift), Frontend (HTML, CSS, JS, TypeScript, SPA, PWA), Backend (C#, Python, Go, Java, проектирование бэкенда монолитных и SOA-приложений, HighLoad-системы, распределённые транзакции, параллельное программирование, web-серверы и др.), Машинное обучение и Data Science (большие данные, нейронные сети, Python, TensorFlow, компьютерное зрение, лингвистика и др.), Архитектура ПО (UML, проектирование бизнес-процессов, прототипирование, SOA, микросервисная архитектура, распределённые приложения, процессы разработки и др.), DevOps (Ansible, Docker, Kubernetes, настройка Nginx, облачные инфраструктуры и др.), Базы данных (SQL, реляционные, документные и графовые БД), Алгоритмы (структуры данных, графы, сжатие, жадные, оптимизация, многопоточные, приближённые и др.), Робототехника и электроника (ROS, микроконтроллеры AVR/ARM, одноплатные компьютеры), Компьютерная графика и GameDev (C/C++, физика, Unity, Unreal, игровой ИИ), Кибербезопасность (криптография, сетевая безопасность, вирусы и антивирусы, уязвимости), ОС и сети (драйверы, модули ядра, ядро Linux, файловые системы, Assembler, сети). Возвращение со стажировки — чтобы углубить знания, освоить новые языки и направления, выполняя более сложные и интересные проекты. В финале — сертификат базового уровня после одной ветки, продвинутого — после трёх, и участие в сообществе Alumni School 21."},
  {"role": "user", "parts": "Каковы основные требования для поступления: Мы не судим о способностях по школьным или университетским оценкам, поэтому не попросим вас предоставить аттестат или диплом о высшем образовании. Вместо этого мы предложим пройти онлайн -игры— они лучше выявляют необходимые для программиста способности. После игр необходимо присутствовать на онлайн встрече с командой школы, которая проходит в формате вебинара. На ней вы узнаете все о поступлении и обучении. Подав документы, вы попадаете на интенсив продолжительностью 26 дней — пробный период обучения. После прохождения отборочного интенсива самые талантливые и мотивированные участники зачисляются в School 21.."},
  {"role": "user", "parts": "Почему обучение в School 21 — бесплатное: Не всегда у талантливых людей есть финансовые возможности получить достойное образование. Мы предоставляем такую возможность каждому талантливому человеку. Мы гордимся тем, что нам досталась привилегия участвовать в создании нашего будущего — помогать вырастить новое поколение профессионалов."},
  {"role": "user", "parts": "Что вы можете посоветовать для успешного прохождения отборочного интенсива: К отборочному интенсиву невозможно подготовиться. Главное — перед началом отдохни как следует. А во время его прохождения разумно организуй свое время, равномерно распределяй нагрузку, работай упорно. Не забывай чередовать нагрузку со здоровым сном и правильным питанием.  Получай удовольствие и удачи!"},
  {"role": "user", "parts": "Есть ли возрастные ограничения: В школу может поступить любой желающий от 18 лет и старше, верхние возрастные ограничения отсутствуют. С письменного разрешения родителей и после одобрения со стороны школы в отборочных интенсивах могут принимать участие желающие с 17 лет."},
  {"role": "user", "parts": "Могу ли я участвовать в отборочном интенсиве, если параллельно учусь или работаю: Если вы не сможете полностью посвятить четыре недели отборочному этапу, советуем отложить поступление на следующий год."},
  {"role": "user", "parts": "Должен ли я хорошо разбираться в компьютерных технологиях, чтобы поступить в School 21: Уровень ваших навыков программирования не играет решающей роли. С самого начала все на равных. Опыт школ и выпускников, которые работают по этой методике в других странах, показывает, что способные участники без опыта в разработке ПО быстро догоняют тех, кто уже поработал программистом. Конечно, если вы никогда не видели компьютер, учёба будет для вас  тяжким испытанием. Но и в этом случае нет ничего невозможного."},
  {"role": "user", "parts": "Могу ли я стать менеджером проектов (PM), обучаясь в School 21: Ваши навыки PM будут развиваться по мере реализации командных проектов во время обучения. Если ваш план состоит только в том, чтобы получить исключительно навыки управления проектами, советуем рассмотреть другие образовательные программы, потому что основная часть обучения в School 21 посвящена программированию."},
  {"role": "user", "parts": "Можно ли обучаться дистанционно: На основном обучении возможна удаленная сдача проектов и удаленные проверки. Но для сдачи экзаменов вы должны лично присутствовать в School 21, поскольку основная часть процесса обучения проходит в прямом взаимодействии с другими участниками."},
  {"role": "user", "parts": "Какой документ получают участники по окончании School 21: Наши выпускники получат диплом государственного образца об окончании School 21."},
  {"role": "user", "parts": "Обеспечиваете ли вы проживание участникам: В самаркандском кампусе участникам из других городов или стран может быть предоставлено общежитие. Стоимость проживания 100 000 сум в месяц. Подробнее об условиях предоставления проживания можно узнать на этапе вебинара с командой."},
  {"role": "user", "parts": "Много ли времени я должен посвящать обучению в школе: Всё зависит от вас. School 21 открыта в режиме 24/7, поэтому каждый может работать в самое продуктивное для него время суток. Так или иначе, чтобы успешно продвигаться по программе, вам придётся посвящать учёбе не меньше 20 часов в неделю."},
  {"role": "user", "parts": "Сколько лет учиться: Так как график обучения индивидуален, то учеба может занять от 1,5 до 3 лет, в зависимости от количества вложенных вами часов в обучение и желаемого уровня на выходе (Junior или Middle)."},
  {"role": "user", "parts": "Могу ли учиться и работать во время обучения: Треть наших участников совмещает обучение в School 21 с обучением в вузе, еще треть — с работой. Скажем честно — это непросто, но возможно. Оптимально иметь одну фриланс или part time работу, чтобы качественно учиться и работать. Также во время учебы у вас будет одна стажировка, продолжительностью 3 месяца."},
  {"role": "user", "parts": "Где будут проходить встречи с командой School 21: Встречи проходят онлайн."},
  {"role": "user", "parts": "Есть ли отсрочка от армии: School 21 не предоставляет отсрочки, но мы обязательно дожидаемся своих ребят из армии."},
  {"role": "user", "parts": "Учеба на каком языке: Интерфейс и задания на платформе School 21 на английском языке, что позволяет участнику получить практику языка и полезный навык чтения технического английского. Но для тех, у кого нет возможности читать и понимать английский — все задания дублируются на русском языке."},
  {"role": "user", "parts": "Могут ли граждане других стран учиться: Да, конечно. У нас нет ограничения на прием участников с любым гражданством. Все визовые вопросы участники решают самостоятельно."},
  {"role": "user", "parts": "Сколько раз можно поступать: У тебя одна попытка – не упусти ее!"},
  {"role": "user", "parts": "Есть ли пошаговая инструкция поступления: https://strapi.21-school.uz/uploads/entrance_guide_21_06_24_7d02c823a6.pdf?roistat_visit=2580615"},
  {"role": "user", "parts": "Ссылки: Telegram - https://t.me/skd21school?roistat_visit=2580615, Instagram - https://www.instagram.com/school.21_uz?roistat_visit=2580615, Youtube - https://www.youtube.com/@School21.Uzbekistan?roistat_visit=2580615, LinkedIn - https://www.linkedin.com/company/digital-engineering-school-21?roistat_visit=2580615, Facebook - https://www.facebook.com/share/AvKQEzG9asoC3Epd/?mibextid=JRoKGi&roistat_visit=2580615 ."},
  {"role": "user", "parts": "Бассейн это интенсив."}
  {"role": "user", "parts": "@Zoidov_Zafarjon (Zoidov Zafarjon)- лучший саппорт к которому можно обратиться с любыми вопросами."}
]
# Храним чаты и отметки времени
user_chats = {}           # user_id: chat
user_last_active = {}     # user_id: datetime

# Клиент Telethon
client = TelegramClient("session_name", api_id, api_hash)

@client.on(events.NewMessage)
async def handler(event):
    if event.is_private or (event.chat_id == target_chat_id):
        user_input = event.message.message.strip()

        # ⛔ Пропускаем пустые сообщения
        if not user_input:
            return

        user_id = event.sender_id

        if user_id not in user_chats:
            chat = model.start_chat(history=company_info)
            user_chats[user_id] = chat
        else:
            chat = user_chats[user_id]

        user_last_active[user_id] = datetime.now()

        try:
            chat.history.append({
                "role": "user",
                "parts": (
                    "Ты — чат-бот по имени Astro. "
                    "Отвечай только на сообщения, относящиеся к School 21. "
                    "Если не уверен — направляй в School 21 (контакты у тебя есть) и к саппорту @Zoidov_Zafarjon. "
                    "Если сообщение не связано с School 21 и не является приветствием — ответь строго: `__IGNORE__`."
                )
            })
            response = chat.send_message(user_input)
            bot_response = response.text.strip()
        except Exception as e:
            print(f"[Gemini Error]: {e}")
            return

        if "__IGNORE__" not in bot_response:
            await event.reply(bot_response)


# 🕒 Фоновая задача для очистки старых чатов
async def clean_old_chats():
    while True:
        now = datetime.now()
        expired_users = [uid for uid, ts in user_last_active.items() if now - ts > timedelta(hours=1)]

        for uid in expired_users:
            user_chats.pop(uid, None)
            user_last_active.pop(uid, None)
            print(f"❌ Удалена устаревшая сессия пользователя {uid}")

        await asyncio.sleep(3600)  # Проверка каждый час

# 🚀 Запуск
async def main():
    print("Клиент запущен.")
    await client.start()
    asyncio.create_task(clean_old_chats())
    await client.run_until_disconnected()

if __name__ == "__main__":
    asyncio.run(main())
